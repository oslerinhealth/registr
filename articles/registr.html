<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>registr: a vignette • registr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="registr: a vignette">
<meta property="og:description" content="registr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">registr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/registr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/incomplete_curves.html">Registering Incomplete Curves</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="registr_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>registr: a vignette</h1>
                        <h4 data-toc-skip class="author">Julia Wrobel, Alexander Bauer and Erin McDonnell</h4>
            
            <h4 data-toc-skip class="date">2021-05-20</h4>
      
      
      <div class="hidden name"><code>registr.Rmd</code></div>

    </div>

    
    
<style type="text/css">
h1 { /* Header 1 */
  font-size: 26px;
}
h2 { /* Header 2 */
  font-size: 20px;
}
h3 { /* Header 3 */
  font-size: 16px;
}
</style>
<p>The <code>registr</code> package is for registering, or aligning, exponential family functional data.</p>
<p>This vignette outlines the general functionality of the package. The package can handle both complete and incomplete functional data, i.e. curves which were not observed from the very beginning and/or until the very end of the common domain. Details on how to handle incomplete curves with the <code>registr</code> package can be found in the separate vignette <code>"incomplete_curves"</code>.</p>
<div id="what-is-exponential-family-registration" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is-exponential-family-registration" class="anchor" aria-hidden="true"></a>What is exponential family registration?</h1>
<p>Functional data analysis is a set of tools for understanding patterns and variability in data where the basic unit of observation is a curve measured over some domain such as time or space. An example is an accelerometer study where intensity of physical activity was measured at each minute over 24 hours for 50 subjects. The data will contain 50 curves, where each curve is the 24-hour activity profile for a particular subject.</p>
<p>Classic functional data analysis assumes that each curve is continuous or comes from a Gaussian distribution. However, applications with exponential family functional data – curves that arise from any exponential family distribution, and have a smooth latent mean – are increasingly common. For example, take the accelerometer data just mentioned, but assume researchers are interested in <em>sedentary behavior</em> instead of <em>activity intensity</em>. At each minute over 24 hours they collect a binary measurement that indicates whether a subject was active or inactive (sedentary). Now we have a <em>binary curve</em> for each subject – a trajectory where each time point can take on a value of 0 or 1. We assume the binary curve has a smooth latent mean, which in this case is interpreted as the probability of being active at each minute over 24 hours. This is a example of exponential family functional data.</p>
<p>Often in a functional dataset curves have similar underlying patterns but the main features of each curve, such as the minimum and maximum, have shifts such that the data appear misaligned. This misalignment can obscure patterns shared across curves and produce messy summary statistics. Registration methods reduce variability in functional data and clarify underlying patterns by aligning curves.</p>
<p>At the core of this registration method is generalized functional principal components analysis (GFPCA), a popular technique for extracting patterns shared across curves.</p>
<div id="the-registr-model-and-algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#the-registr-model-and-algorithm" class="anchor" aria-hidden="true"></a>The <code>registr</code> model and algorithm</h2>
<p>The main model for exponential family registration is</p>
<p><span class="math display">\[
\begin{eqnarray*}
E\left[Y_i\left(h_i^{-1}(t_i^*)\right) | c_i, h_i^{-1} \right] &amp;=&amp; \mu_i(t) \\
g\left[\mu_i(t)\right]&amp;=&amp; \alpha(t) + \sum_{k = 1}^K c_{ik}\psi_k(t).
\end{eqnarray*}
\]</span> For subject <span class="math inline">\(i\)</span>, inverse warping function <span class="math inline">\(h_i^{-1}\)</span> maps unregistered time <span class="math inline">\(t_i^*\)</span> to registered time <span class="math inline">\(t\)</span> such that <span class="math inline">\(h_i^{-1}(t_i^*) = t\)</span>. <span class="math inline">\(Y_i\left(t_i^*\right)\)</span> and <span class="math inline">\(Y_i\left(h_i^{-1}(t_i^*)\right)\)</span> are the unregistered and registered response curves, respectively. The subject-specific means <span class="math inline">\(\mu_i(t)\)</span> are related to the population-level mean <span class="math inline">\(\alpha(t)\)</span> and a linear combination of population-level basis functions <span class="math inline">\(\psi(t)\)</span> and subject-specific scores <span class="math inline">\(c_i\)</span> through a known link function <span class="math inline">\(g\)</span>.</p>
<p>The <code>registr</code> algorithm is based on this model and iterates between the following steps:</p>
<ol style="list-style-type: decimal">
<li>Estimate subject-specific means <strong><span class="math inline">\(\mu_i(t)\)</span></strong> using GFPCA, conditional on current estimate of <span class="math inline">\(h_i^{-1}(t_i^*)\)</span>.</li>
<li>Estimate inverse warping functions <strong><span class="math inline">\(h_i^{-1}(t_i^*)\)</span></strong>, conditional on current estimate of <span class="math inline">\(\mu_i(t)\)</span>.</li>
</ol>
<p>The methods implemented in <code>registr</code> are described in more detail in this <a href="http://juliawrobel.com/Downloads/registration_ef.pdf" class="external-link">paper</a>.</p>
</div>
</div>
<div id="the-registr-package" class="section level1">
<h1 class="hasAnchor">
<a href="#the-registr-package" class="anchor" aria-hidden="true"></a>The <code>registr</code> package</h1>
<p>The main function in the package is <code><a href="../reference/register_fpca.html">register_fpca()</a></code>. It calls two sub-functions: a GFPCA function to implement <strong>step 1</strong> of the iterative algorithm, and <code><a href="../reference/registr.html">registr()</a></code>, a function to implement <strong>step 2</strong> of the algorithm. The function that calculates GFPCA can either be based on the variational EM approach outlined in <span class="citation">Wrobel et al. (2019)</span> or the two-step method outlined in <span class="citation">Gertheiss, Goldsmith, and Staicu (2017)</span>. In the former case, the called function depends on the family. For <code>family = "gaussian"</code> (for continuous data) and <code>family = "binomial"</code> (for binary data) the functions <code><a href="../reference/bfpca.html">bfpca()</a></code> and <code><a href="../reference/fpca_gauss.html">fpca_gauss()</a></code> are called for the GFPCA step, respectively. In the latter case, function <code><a href="../reference/gfpca_twoStep.html">gfpca_twoStep()</a></code> is called, which also supports families <code>"gamma"</code> (for strictly positive data where the variance depends on the mean) and <code>"poisson"</code> (for nonnegative count data). The <code><a href="../reference/register_fpca.html">register_fpca()</a></code> function iterates between the alignment and template calculation steps until curves are registered.</p>
<div id="a-note-on-data-formatting" class="section level2">
<h2 class="hasAnchor">
<a href="#a-note-on-data-formatting" class="anchor" aria-hidden="true"></a>A note on data formatting</h2>
<p>Use of this package requires that data be in a specific format: a long-form data frame with variables <code>id</code>, <code>index</code>, and <code>value</code>, where the <code>value</code> column contains functional observations for all subjects, the <code>id</code> column identifies which observations belong to which subject, and <code>index</code> provides the grid (domain) over which the <code>value</code>s are observed.</p>
<p>The variable <code>id</code> should be a unique identifier in that each id identifies a single subject. Since we assume there is only one curve per subject for this package, <code>id</code> uniquely identifies each curve as well. Other covariates can be included in the data as long as the variables <code>id</code>, <code>index</code>, and <code>value</code> are present.</p>
</div>
</div>
<div id="data-simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#data-simulation" class="anchor" aria-hidden="true"></a>Data simulation</h1>
<p>There are two functions for simulating data included in the package: <code><a href="../reference/simulate_unregistered_curves.html">simulate_unregistered_curves()</a></code> and <code><a href="../reference/simulate_functional_data.html">simulate_functional_data()</a></code>. Both simulate functional data; the first is intended for demonstrating the registration algorithm and the second is for testing GFPCA sub-functions in the package.</p>
<div id="simulate-data-for-registration" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-data-for-registration" class="anchor" aria-hidden="true"></a>Simulate data for registration</h2>
<p><code><a href="../reference/simulate_unregistered_curves.html">simulate_unregistered_curves()</a></code> generates curves with both unregistered and registered time grids.The code below generates data with <span class="math inline">\(I = 10\)</span> subjects and <span class="math inline">\(D = 200\)</span> using this function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registration_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_unregistered_curves.html">simulate_unregistered_curves</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">50</span>, D <span class="op">=</span> <span class="fl">200</span>, seed <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">registration_data</span><span class="op">)</span>
<span class="co">#&gt;   id       index value latent_mean           t</span>
<span class="co">#&gt; 1  1 0.000000000     0   -1.408706 0.000000000</span>
<span class="co">#&gt; 2  1 0.005025126     0   -1.447980 0.004501377</span>
<span class="co">#&gt; 3  1 0.010050251     0   -1.486200 0.009015300</span>
<span class="co">#&gt; 4  1 0.015075377     0   -1.523325 0.013541660</span>
<span class="co">#&gt; 5  1 0.020100503     0   -1.559314 0.018080346</span>
<span class="co">#&gt; 6  1 0.025125628     0   -1.594127 0.022631248</span></code></pre></div>
<p>The resulting object,<code>registration_data</code>, is a data frame with variables <code>id</code>, <code>value</code>, <code>index</code>, <code>latent_mean</code>, and <code>t</code>, which is consistent with the format our <code>registr</code> software requires. <code>id</code> is the identifier for a particular subject, the <code>value</code> variable contains binary observations, and <code>latent_mean</code> contains continuous observations used to generate the binary observations for the <code>value</code> variable. Note that when <code>family = "binomial"</code> we will use the binary <code>value</code> variable as the observations for each subject and when <code>family = "gaussian"</code> we use the <code>latent_mean</code> variable as the outcome.</p>
<p>The variables <code>index</code> and <code>t</code> are both time grids. Evaluated on the grid <code>index</code> the data is unregistered, and on the grid <code>t</code> the data is registered. Registered and unregistered curves are plotted below.</p>
<p><img src="registr_files/figure-html/plot_sim2-1.png" width="576"></p>
<p>Each curve has one main peak, but the location of that peak is shifted. When curves are registered the peaks are aligned.</p>
</div>
<div id="simulate-data-for-gfpca" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-data-for-gfpca" class="anchor" aria-hidden="true"></a>Simulate data for GFPCA</h2>
<p><code><a href="../reference/simulate_functional_data.html">simulate_functional_data()</a></code> simulates data with a population-level mean and two orthogonal principal components based on sine and cosine functions. The code below generates data with <span class="math inline">\(I = 100\)</span> subjects and <span class="math inline">\(D = 200\)</span> time points per subject using this function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fpca_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_functional_data.html">simulate_functional_data</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">100</span>, D <span class="op">=</span> <span class="fl">200</span>, seed <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">fpca_data</span><span class="op">)</span>
<span class="co">#&gt; [1] "alpha" "psi1"  "psi2"  "Y"</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpca_data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt;   id value       index latent_mean</span>
<span class="co">#&gt; 1  1     0 0.000000000   -1.549878</span>
<span class="co">#&gt; 2  1     0 0.005025126   -1.540848</span>
<span class="co">#&gt; 3  1     0 0.010050251   -1.528362</span>
<span class="co">#&gt; 4  1     0 0.015075377   -1.512449</span>
<span class="co">#&gt; 5  1     1 0.020100503   -1.493144</span>
<span class="co">#&gt; 6  1     0 0.025125628   -1.470490</span></code></pre></div>
<p>The resulting object,<code>fpca_data</code>, is a list that contains the true population-level mean (<code>alpha</code>) and principal components (<code>psi1</code> and <code>psi2</code>), and a dataframe (<code>Y</code>). The dataframe <code>Y</code> contains variables <code>id</code>, <code>value</code>, <code>index</code> and <code>latent_mean</code>. This data is plotted below.</p>
<p><img src="registr_files/figure-html/plot1_sim1-1.png" width="576"></p>
<p>The left panel of the figure above shows the latent means for each subject, along with the population-level mean, <span class="math inline">\(\alpha(t)\)</span>, in red. The middle and right panels show the first and second principal components, <span class="math inline">\(\psi_1(t)\)</span> and <span class="math inline">\(\psi_2(t)\)</span>, respectively. Using the <span class="math inline">\(logit^{-1}(\cdot)\)</span> function we can convert the subject-specific means to probabilities; these probabilities are used to generate the binary values. Binary values and latent probability curve for one subject in the dataset is shown below.</p>
<p><img src="registr_files/figure-html/plot2_sim1-1.png" width="576"></p>
<p>We can alter the score variance for the principal components using the arguments <code>lambda1</code> and <code>lambda2</code>. The default setting is for all subjects to have the same number of time points. However, by specifying <code>vary_D = TRUE</code>, we can generate data with uneven grid lengths for each subject.</p>
</div>
</div>
<div id="joint-registration-and-gfpca-using-register_fpca" class="section level1">
<h1 class="hasAnchor">
<a href="#joint-registration-and-gfpca-using-register_fpca" class="anchor" aria-hidden="true"></a>Joint registration and GFPCA using <code>register_fpca()</code>
</h1>
<p><code><a href="../reference/register_fpca.html">register_fpca()</a></code> is the main function for the <code>registr</code> package. Use the <code>family</code> argument to this function to specify what type of exponential family data you would like to align. The package supports <code>family = "gaussian"</code> for registering continuous data, <code>family = "binomial"</code> for registering binary data, <code>family = "gamma"</code> for strictly positive data where the variance depends on the mean and <code>family = "poisson"</code> for nonnegative count data. The type of GFPCA is specified by the argument <code>fpca_type</code>, either calling the variational EM approach of <span class="citation">Wrobel et al. (2019)</span> (<code>fpca_type = "variationalEM</code>; default) or the two-step approach of <span class="citation">Gertheiss, Goldsmith, and Staicu (2017)</span> (<code>fpca_type = "two-step"</code>).</p>
<div id="analyzing-binary-data" class="section level2">
<h2 class="hasAnchor">
<a href="#analyzing-binary-data" class="anchor" aria-hidden="true"></a>Analyzing binary data</h2>
<p>To register binary data use the following code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registr_bin</span> <span class="op">=</span> <span class="fu"><a href="../reference/register_fpca.html">register_fpca</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">registration_data</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, Kt <span class="op">=</span> <span class="fl">8</span>, Kh <span class="op">=</span> <span class="fl">4</span>, npc <span class="op">=</span> <span class="fl">1</span>, verbose <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>The argument <code>Y</code> specifies the input dataset; this code uses the simulated <code>registration_data</code>. <code>Kt</code> and <code>Kh</code> specify number of B-spline basis functions for the subject-specific means and warping functions, respectively, and <code>npc</code> indicates the number of functional principal components to use. The latter can also be chosen based on an explained share of variance, see argument <code>npc_varExplained</code>.</p>
<p><img src="registr_files/figure-html/plot_reg_bin-1.png" width="576"></p>
<p>Underlying probabilities of the binary data are plotted above. At left probabilities on unregistered domain <span class="math inline">\(t^*\)</span>, center are probabilities on true registered domain <span class="math inline">\(t\)</span>, and at right are probabilities on estimated registered domain <span class="math inline">\(\widehat{t}\)</span>. After registration the underlying probabilities are aligned – though it is important to note that the algorithm registers based on the underlying binary observations, not the true probabilities.</p>
<p><img src="registr_files/figure-html/plot_reg_bin_warp-1.png" width="576"></p>
<p>The true and estimated warping functions are plotted above.</p>
</div>
<div id="analyzing-gaussian-data" class="section level2">
<h2 class="hasAnchor">
<a href="#analyzing-gaussian-data" class="anchor" aria-hidden="true"></a>Analyzing gaussian data</h2>
<p>To register continuous data use the following code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registration_data</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="va">registration_data</span><span class="op">$</span><span class="va">latent_mean</span>
<span class="va">registr_gauss</span> <span class="op">=</span> <span class="fu"><a href="../reference/register_fpca.html">register_fpca</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">registration_data</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>, npc <span class="op">=</span> <span class="fl">1</span>, Kt <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="estimating-the-gfpca" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-the-gfpca" class="anchor" aria-hidden="true"></a>Estimating the GFPCA</h1>
<p>Approaches for (Generalized) FPCA are implemented in functions specific for gaussian data (<code><a href="../reference/fpca_gauss.html">fpca_gauss()</a></code>) and binomial data (<code><a href="../reference/bfpca.html">bfpca()</a></code>). Alternatively, <code><a href="../reference/gfpca_twoStep.html">gfpca_twoStep()</a></code> allows to apply GFPCA also for other exponential family distributions.</p>
<div id="binomial-fpca-using-bfpca" class="section level2">
<h2 class="hasAnchor">
<a href="#binomial-fpca-using-bfpca" class="anchor" aria-hidden="true"></a>Binomial FPCA using <code>bfpca()</code>
</h2>
<p>The <code>registr</code> package includes a novel variational EM algorithm for binary functional principal component analysis (bfpca), derived from methods for binary probabilistic PCA <span class="citation">(Tipping 1999)</span>.</p>
<p>This <code><a href="../reference/bfpca.html">bfpca()</a></code> function works for data that is sparse and irregular (subjects do not have to be observed on the same grid and do not have to have the same number of grid points), as well as dense, regularly observed data. The following code runs bfpca on the <code>fpca_data</code> dataset.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bfpca_object</span> <span class="op">=</span> <span class="fu"><a href="../reference/bfpca.html">bfpca</a></span><span class="op">(</span><span class="va">fpca_data</span><span class="op">$</span><span class="va">Y</span>, npc <span class="op">=</span> <span class="fl">2</span>, Kt <span class="op">=</span> <span class="fl">8</span>, print.iter <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The argument <code>print.iter = TRUE</code> prints the error after each iteration. The true and estimated population-level mean and FPCs are plotted below.</p>
<p><img src="registr_files/figure-html/plot_bfpca-1.png" width="576"></p>
<p>The algorithm runs quickly and does a good job recovering the true FPCs. Note that while the truth and estimation are not perfectly aligned, this is to be expected – the data used to estimate these functions are binary observations that are generated for the truth with some variability, so results are not expected to perfectly align. One would expect results to get better with increasing number of time points per subject.</p>
<p>In <code>registr</code>, the estimated FPCs can be easily visualized using the internal function <code>plot.fpca</code>. This function is automatically called when calling the general <code>plot</code> function on an object of class <code>fpca</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">have_ggplot2</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"cowplot"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">registr</span><span class="fu">:::</span><span class="fu"><a href="../reference/plot.fpca.html">plot.fpca</a></span><span class="op">(</span><span class="va">bfpca_object</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="registr_files/figure-html/plot.fpca-1.png" width="576"></p>
</div>
<div id="generalized-fpca-using-gfpca_twostep" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-fpca-using-gfpca_twostep" class="anchor" aria-hidden="true"></a>Generalized FPCA using <code>gfpca_twoStep()</code>
</h2>
<p>If <code><a href="../reference/register_fpca.html">register_fpca()</a></code> is called with <code>fpca_type = "two-step"</code>, the GFPCA step is performed with function <code><a href="../reference/gfpca_twoStep.html">gfpca_twoStep()</a></code>. As <span class="citation">Gertheiss, Goldsmith, and Staicu (2017)</span> outline, in comparison to purely marginal and thus biased GFPCA approaches, this two-step approach can be seen as a <em>“quick-fix” for the marginal approach</em> of <span class="citation">Hall, Müller, and Yao (2008)</span> that <em>works well in practice</em>.</p>
<p>Our implementation is based on the codebase accompanying their paper which can be found at <a href="https://www.github.com/jeff-goldsmith/gfpca" class="external-link">github.com/jeff-goldsmith/gfpca</a>. We further adapted the functions to work more efficiently both regarding the need for computation time and RAM, especially for large data settings with thousands of curves.</p>
</div>
</div>
<div id="estimating-the-registration-using-registr" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-the-registration-using-registr" class="anchor" aria-hidden="true"></a>Estimating the registration using <code>registr()</code>
</h1>
<p>The registration step of <code><a href="../reference/register_fpca.html">register_fpca()</a></code> calls the <code>registr</code> function. Though registration is intended to be performed through the <code><a href="../reference/register_fpca.html">register_fpca()</a></code> function <code><a href="../reference/registr.html">registr()</a></code> can work as a standalone function. <code><a href="../reference/registr.html">registr()</a></code> uses constrained maximization of an exponential family likelihood function to estimate functions that align curves.</p>
<p>The default option <code>gradient = TRUE</code> uses an analytic gradient for this optimization problem (available for families <code>"gaussian"</code> and <code>"binomial"</code>). For families <code>"gamma"</code> and <code>"poisson"</code>, the gradient is computed numerically and thus less computationally efficient. The difference in computation time between <code>gradient = TRUE</code> and <code>gradient = FALSE</code> is illustrated in the code below, for <code>family = "binomial"</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_test_gradient</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_unregistered_curves.html">simulate_unregistered_curves</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">50</span>, D <span class="op">=</span> <span class="fl">100</span>, seed <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span>

<span class="va">start_time</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">reg_analytic</span> <span class="op">=</span> <span class="fu"><a href="../reference/registr.html">registr</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">data_test_gradient</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, gradient <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">end_time</span>     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">analytic_gradient</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">start_time</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">reg_numeric</span> <span class="op">=</span> <span class="fu"><a href="../reference/registr.html">registr</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">data_test_gradient</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, gradient <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">end_time</span>    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">numeric_gradient</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">end_time</span> <span class="op">-</span> <span class="va">start_time</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>In this example with just 50 subjects and 100 time points per subject, the <code><a href="../reference/registr.html">registr()</a></code> function runs in 0.72 seconds with an analytic gradient and 1.14 seconds with a numeric gradient. Since the <code><a href="../reference/register_fpca.html">register_fpca()</a></code> algorithm is iterative and calls the <code><a href="../reference/registr.html">registr()</a></code> function several times, using an analytic derivative drastically increases the computational efficiency, especially if the number of subjects in the data is large.</p>
<p>Running the above example with 1000 subjects and 500 time points yields computation times of 19.2 seconds (for the analytic gradient) and 34.6 (for the numeric gradient).</p>
<p>The registration step can further be parallelized by using the <code>cores</code> argument.</p>
</div>
<div id="additional-features" class="section level1">
<h1 class="hasAnchor">
<a href="#additional-features" class="anchor" aria-hidden="true"></a>Additional features</h1>
<div id="registering-incomplete-curves" class="section level2">
<h2 class="hasAnchor">
<a href="#registering-incomplete-curves" class="anchor" aria-hidden="true"></a>Registering incomplete curves</h2>
<p>Incomplete curves arise in many applications. Incompleteness refers to functional data where (some) curves were not observed from the very beginning and/or until the very end of the common domain. Such a data structure is e.g. observed in the presence of drop-out in panel studies.</p>
<p>The <code>registr</code> package offers the possibility to flexibly account for different types of incompleteness structures in the registration using <code><a href="../reference/registr.html">registr()</a></code> as well as in the joint approach using <code><a href="../reference/register_fpca.html">register_fpca()</a></code>. All incomplete curve functionalities are outlined in the separate vignette <code>"incomplete_curves"</code>.</p>
</div>
<div id="parametric-inverse-warping-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#parametric-inverse-warping-functions" class="anchor" aria-hidden="true"></a>Parametric inverse warping functions</h2>
<p>The <code>registr</code> package currently supports two types of inverse warping functions: nonparmetric B-spline basis functions (default), or parametric 2-knot piecewise linear functions. With <code>warping = "piecewise_linear2"</code>, the registration step estimates the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> (or <span class="math inline">\(t_i^*\)</span> and <span class="math inline">\(t\)</span>) coordinates of each of the two knots to construct an inverse warping function that consists of 3 line segments.</p>
<p>To register data with parametric inverse warping functions, using the following code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registration_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_unregistered_curves.html">simulate_unregistered_curves</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">10</span>, D <span class="op">=</span> <span class="fl">50</span>, seed <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span>

<span class="va">registr_parametric</span> <span class="op">=</span> <span class="fu"><a href="../reference/register_fpca.html">register_fpca</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">registration_data</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, 
                                   Kt <span class="op">=</span> <span class="fl">8</span>, Kh <span class="op">=</span> <span class="fl">4</span>, npc <span class="op">=</span> <span class="fl">1</span>, gradient <span class="op">=</span> <span class="cn">FALSE</span>,
                                   warping <span class="op">=</span> <span class="st">"piecewise_linear2"</span><span class="op">)</span></code></pre></div>
<p>This argument works for all families. Note that the <code>gradient</code> option is currently unavailable for parametric inverse warping functions. Below are the resulting inverse warping functions from both the <code>nonparametric</code> (left) and <code>piecewise_linear2</code> (right) specifications. The slopes of the 3 line segments that make up one’s parametric function can provide some interpretation about how that particular subject’s data was warped to align with the population mean.</p>
<p><img src="registr_files/figure-html/register_parametric_plots-1.png" width="576"></p>
<p>Beyond interpretability, another advantage of parametric inverse warping functions is the ability to specify prior information about how they should look. The <code><a href="../reference/register_fpca.html">register_fpca()</a></code> function can include normally-distributed priors which pull warping functions toward the identity line. Specifically, the priors pull the knot coordinates toward (0.25, 0.25) and (0.75, 0.75).</p>
<p>To activate the priors, one must specify <code>priors = TRUE</code> and choose a value for the argument <code>prior_sd</code>, the standard deviation that will be applied to all 4 prior distributions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registr_par_priors</span> <span class="op">=</span> <span class="fu"><a href="../reference/register_fpca.html">register_fpca</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">registration_data</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, 
                                   Kt <span class="op">=</span> <span class="fl">8</span>, Kh <span class="op">=</span> <span class="fl">4</span>, npc <span class="op">=</span> <span class="fl">1</span>, gradient <span class="op">=</span> <span class="cn">FALSE</span>,
                                   warping <span class="op">=</span> <span class="st">"piecewise_linear2"</span>,
                                   priors <span class="op">=</span> <span class="cn">TRUE</span>, prior_sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p>As expected, a smaller variance lead to stronger tendency toward the prior means. This is demonstrated in the warping function plots below.</p>
<p><img src="registr_files/figure-html/register_par_priors_plots-1.png" width="576"></p>
<p>The ability to specify priors is currently only available for binary curve registration, not Gaussian.</p>
</div>
<div id="periodic-b-spline-basis-functions-for-gfpca" class="section level2">
<h2 class="hasAnchor">
<a href="#periodic-b-spline-basis-functions-for-gfpca" class="anchor" aria-hidden="true"></a>Periodic B-spline basis functions for GFPCA</h2>
<p>In some cases it may be of interest to place periodic boundary conditions on the B-spline basis functions for the population-level and subject-specific mean templates. The periodic conditions ensure that the resulting function starts and ends with the same value. This may be useful when modeling cyclical data, such as daily physical activity patterns. To use periodic B-spline basis functions during registration, use the option <code>periodic = TRUE</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">registr_periodic</span> <span class="op">=</span> <span class="fu"><a href="../reference/register_fpca.html">register_fpca</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">registration_data</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, 
                                 Kt <span class="op">=</span> <span class="fl">8</span>, Kh <span class="op">=</span> <span class="fl">4</span>, npc <span class="op">=</span> <span class="fl">1</span>, gradient <span class="op">=</span> <span class="cn">FALSE</span>,
                                 periodic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Note that the <code>gradient</code> option is currently unavailable for <code>periodic = TRUE</code>.</p>
<p>The resulting population mean and principal component from registering the continuous data using <code>periodic = FALSE</code> (default) and <code>periodic = TRUE</code> are plotted below, with dotted lines to demonstrate the unification of the start and end of the periodic functions.</p>
<p><img src="registr_files/figure-html/register_fpca_periodic-1.png" width="576"></p>
</div>
<div id="choosing-the-template-function" class="section level2">
<h2 class="hasAnchor">
<a href="#choosing-the-template-function" class="anchor" aria-hidden="true"></a>Choosing the template function</h2>
<p>By default <code><a href="../reference/registr.html">registr()</a></code> estimates the overall mean of all curves and uses this mean curve as the template function to which all curves are registered. In the joint approach (<code><a href="../reference/register_fpca.html">register_fpca()</a></code>) this mean curve is used as template for an initial registration step, before the main iteration between registration and GFPCA starts.</p>
<p>In some situations the overall mean is not the most reasonable choice for the template. See for example the following curves with a <em>trailing incompleteness</em> structure where some processes were not observed until their very end. The shape of the mean curve does not match any of the observed curve shapes well.</p>
<p><img src="registr_files/figure-html/template%20data%20sim-1.png" width="480"></p>
<p>Performing the registration with this mean curve as template would lead to the following result:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reg1</span> <span class="op">=</span> <span class="fu"><a href="../reference/registr.html">registr</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">temp_dat</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>, Kh <span class="op">=</span> <span class="fl">4</span>,
               incompleteness <span class="op">=</span> <span class="st">"trailing"</span>, lambda_inc <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">have_ggplot2</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">reg1</span><span class="op">$</span><span class="va">Y</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">index</span>, y <span class="op">=</span> <span class="va">value</span>, col <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Registration with overall mean (black) as template function"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="registr_files/figure-html/temp%20registration%20without%20template-1.png" width="480"></p>
<p>Alternatively, the template function can be manually defined using one of the following options:</p>
<ol style="list-style-type: decimal">
<li>Define the template as the mean curve only based on some subset of the observed curves <code>Y</code>
</li>
<li>Define the template as one observed curve</li>
<li>Define the template curve independently from the observed curves</li>
</ol>
<p>The subset of curves (for option 1) or one specific curve (for options 2 and 3) can be specified using the argument <code>Y_template</code>. In the following example, the red curve with id 1 is used as template:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Y_template</span> <span class="op">=</span> <span class="va">temp_dat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">reg2</span> <span class="op">=</span> <span class="fu"><a href="../reference/registr.html">registr</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">temp_dat</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>, Kh <span class="op">=</span> <span class="fl">4</span>, Y_template <span class="op">=</span> <span class="va">Y_template</span>,
               incompleteness <span class="op">=</span> <span class="st">"trailing"</span>, lambda_inc <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">have_ggplot2</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">reg2</span><span class="op">$</span><span class="va">Y</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">index</span>, y <span class="op">=</span> <span class="va">value</span>, col <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Registration with red curve as template"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="registr_files/figure-html/temp%20registration%20with%20template-1.png" width="480"></p>
</div>
</div>
<div id="help-files" class="section level1">
<h1 class="hasAnchor">
<a href="#help-files" class="anchor" aria-hidden="true"></a>Help files</h1>
<p>Documentation for individual functions gives more information on their arguments and return objects, and can be pulled up via the following:</p>
<ul>
<li><code><a href="../reference/register_fpca.html">?register_fpca</a></code></li>
<li><code><a href="../reference/registr.html">?registr</a></code></li>
<li><code><a href="../reference/bfpca.html">?bfpca</a></code></li>
<li><code><a href="../reference/fpca_gauss.html">?fpca_gauss</a></code></li>
<li><code><a href="../reference/gfpca_twoStep.html">?gfpca_twoStep</a></code></li>
</ul>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor" aria-hidden="true"></a>References</h1>
<div id="refs" class="references">
<div id="ref-gertheiss_2017">
<p>Gertheiss, J., J. Goldsmith, and AM. Staicu. 2017. “A Note on Modeling Sparse Exponential-Family Functional Response Curves.” <em>Computational Statistics &amp; Data Analysis</em> 105: 46–52.</p>
</div>
<div id="ref-hall_2008">
<p>Hall, P., HG. Müller, and F. Yao. 2008. “Modelling Sparse Generalized Longitudinal Observations with Latent Gaussian Processes.” <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 70 (4): 703–23.</p>
</div>
<div id="ref-tipping_1999">
<p>Tipping, M. E. 1999. “Probabilistic Visualisation of High-Dimensional Binary Data.” In <em>Advances in Neural Information Processing Systems</em>, 592–98.</p>
</div>
<div id="ref-wrobel_2019">
<p>Wrobel, J., V. Zipunnikov, J. Schrack, and J. Goldsmith. 2019. “Registration for Exponential Family Functional Data.” <em>Biometrics</em> 75 (1): 48–57.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Julia Wrobel, Alexander Bauer, Jeff Goldsmith, Erin McDonnell.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
